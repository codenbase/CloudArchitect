# Operator å¼€å‘æŒ‡å—ï¼šå·¥å…·é€‰å‹ã€ç”Ÿæ€å…¨æ™¯ä¸å®æˆ˜è½åœ°

åœ¨ä¹‹å‰çš„å‡ ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬åƒå‰¥æ´‹è‘±ä¸€æ ·ï¼Œå±‚å±‚å‰–æäº† [Kubernetes API è®¾è®¡å“²å­¦](https://mp.weixin.qq.com/s/zJ9jSm1daYGrYovY4CmkXA)ã€[è°ƒè°å¾ªç¯](https://mp.weixin.qq.com/s/UbOd70EOc66IdvGt4VyRlw)ä»¥åŠ[CRD çš„æ ¸å¿ƒæ¦‚å¿µ](https://mp.weixin.qq.com/s/IcetGSSM5lBvHrseYw9I9w)ï¼Œç›¸ä¿¡ä½ æ­¤æ—¶å·²ç»åœ¨è„‘æµ·ä¸­å»ºç«‹èµ·äº† Operator çš„ç†è®ºæ¨¡å‹ã€‚

ç„¶è€Œï¼Œçº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ã€‚åªæœ‰å½“ä½ çœŸæ­£æ‰“å¼€ IDEï¼Œé¢å¯¹å…·ä½“çš„ç›®å½•ç»“æ„å’Œæ¥å£å®šä¹‰æ—¶ï¼Œæ‰èƒ½çœŸæ­£ç†è§£é‚£äº›æŠ½è±¡æ¦‚å¿µæ˜¯å¦‚ä½•è½åœ°çš„ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬ä»ç†è®ºè¿ˆå‘å®æˆ˜ï¼Œé€šè¿‡ä¸€è¡Œè¡Œä»£ç ï¼Œå»æŒæ¡ Operator å¼€å‘çš„ç²¾é«“ã€‚


## ğŸ› ï¸ å·¥å…·é€‰å‹

å½“ä½ æ‰“å¼€ [K8s å®˜æ–¹æ–‡æ¡£ Operator](https://kubernetes.io/docs/concepts/extend-kubernetes/operator/) è¿™ä¸€ç« èŠ‚ï¼Œä½ ä¼šçœ‹åˆ°å„ç§è¯­è¨€ï¼ˆJava, Python, Rust, Goï¼‰çš„å·¥å…·æ¨èã€‚ä½†ä½œä¸ºäº‘åŸç”Ÿé¢†åŸŸçš„â€œä¸€ç­‰å…¬æ°‘â€ï¼ŒGo å¼€å‘è€…ä»…ä»…ä¼šç”¨å·¥å…·æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬éœ€è¦æ´å¯Ÿæ•´ä¸ªç”Ÿæ€ä½“ç³»çš„è„‰ç»œã€‚

ä¸ºäº†ä¸è®©ä½ è¢«å„ç§åè¯ç»•æ™•ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªç”Ÿæ€æ‹†è§£ä¸ºå››ä¸ªå±‚çº§æ¥ç†è§£ï¼š

### ç¬¬ 1 å±‚ï¼šç¡¬æ ¸æ¨¡å¼ï¼ˆclient-goï¼‰

å…¶å®ï¼Œä½ å®Œå…¨å¯ä»¥ä¸ä½¿ç”¨ä»»ä½•ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œç›´æ¥ä½¿ç”¨ K8s å®˜æ–¹çš„ `client-go` åº“ã€‚å®ƒæ˜¯æ‰€æœ‰ Operator çš„åŸºçŸ³ã€‚å®ƒå¸¦æ¥çš„ä½“éªŒæ˜¯ï¼š

  **â€œæˆ‘æƒ³è¦æŒæ§ä¸€åˆ‡ç»†èŠ‚â€**

åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œä½ éœ€è¦äº²è‡ªå¤„ç† `Informer`ï¼ˆç¼“å­˜ï¼‰ã€`Lister`ï¼ˆç´¢å¼•ï¼‰ã€`Workqueue`ï¼ˆé˜Ÿåˆ—ï¼‰ç­‰åº•å±‚æœºåˆ¶ï¼Œè¿˜è¦åº”å¯¹å¹¶å‘ç«äº‰å’Œé‡è¯•é€»è¾‘ã€‚é™¤éä½ éœ€è¦ä¿®æ”¹ K8s æ ¸å¿ƒæºç æˆ–è¿›è¡Œæå…¶æ·±åº¦çš„å®šåˆ¶ï¼Œå¦åˆ™å¯¹äºæ™®é€šä¸šåŠ¡çš„å¼€å‘ï¼Œ**æˆ‘ä¸æ¨èç›´æ¥è£¸å†™** `client-go`ã€‚

### ç¬¬ 2 å±‚ï¼šæ ¸å¿ƒå¼•æ“ï¼ˆcontroller-runtimeï¼‰

ä¸ºäº†ä¸è®©å¼€å‘è€…é™·å…¥ `client-go` çš„åº•å±‚æ³¥æ½­ï¼Œç¤¾åŒºå°è£…å‡ºäº† `controller-runtime` åº“ã€‚å®ƒåœ¨å†…éƒ¨åŸºäº `client-go` å¸®ä½ æå®šäº†é˜Ÿåˆ—ã€ç¼“å­˜ã€äº‹ä»¶ç›‘å¬ç­‰è„æ´»ç´¯æ´»ï¼Œå¹¶æŠ½è±¡å‡ºäº†ä¸€ä¸ªå¹²å‡€çš„æ¥å£â€”â€”`Reconcile`ï¼ˆ**è°ƒè°**ï¼‰ã€‚å®ƒç»™ä½ çš„ä½“éªŒæ˜¯ï¼š

  **â€œæˆ‘ä¸å…³å¿ƒé˜Ÿåˆ—ç¼“å­˜ï¼Œåªæƒ³å†™ä¸šåŠ¡é€»è¾‘â€**

ä½ ä¸éœ€è¦å…³å¿ƒâ€œCR çš„å˜åŒ–æ˜¯æ€ä¹ˆç›‘å¬åˆ°çš„â€ï¼Œåªéœ€è¦åœ¨ Reconcile å‡½æ•°é‡Œå®ç°ä¸šåŠ¡é—­ç¯ï¼š**è¯»å–å½“å‰çŠ¶æ€ â¡ å¯¹æ¯”æœŸæœ›çŠ¶æ€ â¡ æ‰§è¡Œå˜æ›´ï¼ˆå¢åˆ æ”¹ï¼‰**ã€‚

å®ƒæ˜¯ç°ä»£ Go Operator å¼€å‘çš„æ ‡å‡†åº“ï¼Œä¹Ÿæ˜¯é©±åŠ¨æ§åˆ¶å¾ªç¯ï¼ˆControl Loopï¼‰çš„æ ¸å¿ƒå¼•æ“ã€‚

### ç¬¬ 3 å±‚ï¼šæ ‡å‡†è„šæ‰‹æ¶ (Kubebuilder)

å…‰æœ‰åº“è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆå§‹åŒ–é¡¹ç›®ç»“æ„ã€ç”Ÿæˆ CRD YAMLã€ç¼–å†™ Makefileã€‚äºæ˜¯ï¼ŒKubernetes SIGï¼ˆç‰¹åˆ«å…´è¶£å°ç»„ï¼‰æ¨å‡ºäº† `Kubebuilder`ã€‚å®ƒçš„æ ¸å¿ƒä»·å€¼åœ¨äºï¼š

  **â€œç›´æ¥ç»™ä½ ç”Ÿæˆä¸€ä¸ªå¯ä»¥è·‘çš„é¡¹ç›®â€**

è¿™ä¾èµ–äºå®ƒçš„ä¸¤éƒ¨åˆ†æ ¸å¿ƒèƒ½åŠ›ï¼š

* **è„šæ‰‹æ¶å·¥å…·**ï¼šå¸®ä½ åˆå§‹åŒ–é¡¹ç›®ç›®å½•ï¼Œè‡ªåŠ¨å¼•å…¥ `controller-runtime` ä¾èµ–ã€‚
* **ä»£ç ç”Ÿæˆå™¨**ï¼ˆ`controller-gen`ï¼‰ï¼šè¿™æ˜¯å®ç°è‡ªåŠ¨åŒ–çš„å…³é”®ã€‚å®ƒä¼šæ‰«æä½ çš„ Go ä»£ç ï¼Œæ ¹æ® `//+kubebuilder` è¿™ç±»æ³¨é‡Šæ ‡è®°ï¼Œè‡ªåŠ¨ç”Ÿæˆ CRD å®šä¹‰ã€RBAC æƒé™é…ç½®å’Œ Webhook ä»£ç ã€‚

Kubebuilder æ˜¯ç›®å‰çš„è¡Œä¸šæ ‡å‡†ï¼Œé€‚åˆç»å¤§å¤šæ•°å¼€å‘åœºæ™¯ã€‚

### ç¬¬ 4 å±‚ï¼šä¼ä¸šå…¨å®¶æ¡¶ (Operator Framework)

Operator Framework æ˜¯ç”± Red Hat ä¸»å¯¼çš„å¼€æºé¡¹ç›®ï¼Œå®ƒä¸ä»…ä»…å…³æ³¨â€œå¼€å‘â€ï¼Œæ›´å…³æ³¨â€œè¿ç»´â€å’Œâ€œåˆ†å‘â€ã€‚å½“ä½ å¼€å§‹ä½¿ç”¨å®ƒï¼Œä½ çš„è¯‰æ±‚é€šå¸¸æ˜¯ï¼š

  **â€œæˆ‘è¦æ‰“åŒ…ã€å‘å¸ƒã€ä¸Šæ¶åº”ç”¨å¸‚åœºâ€**

å®ƒåŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼š

1. **Operator SDK**ï¼šå®ƒçš„ Go æ¨¡å¼åº•å±‚ç›´æ¥å¤ç”¨äº† Kubebuilder çš„é€»è¾‘ï¼ˆä½¿ç”¨ `controller-runtime`ï¼‰ï¼Œä½†é¢å¤–æ”¯æŒäº† `Ansible` å’Œ `Helm` å¼€å‘æ¨¡å¼ã€‚
2. **OLMï¼ˆOperator Lifecycle Managerï¼‰**ï¼šæ˜¯ Kubernetes é›†ç¾¤å†…ç®¡ç† Operator çš„åŒ…ç®¡ç†ç³»ç»Ÿï¼Œè´Ÿè´£ Operator çš„å®‰è£…ã€è‡ªåŠ¨å‡çº§ã€ä¾èµ–å…³ç³»å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚
3. **OperatorHub.io**ï¼šå…¬å…±çš„ Operator åº”ç”¨å¸‚åœºã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å•çš„å…¬å¼æ¥ç†è§£å®ƒï¼š

*Operator SDKï¼ˆGoç‰ˆï¼‰= Kubebuilder + lifecycle ç®¡ç†å·¥å…· + OLM bundleæ”¯æŒ*

å¦‚æœä½ çš„å›¢é˜Ÿä¸ç†Ÿæ‚‰ Goï¼ˆéœ€è¦ç”¨ Ansible/Helmï¼‰ï¼Œæˆ–è€…ä½ çš„ Operator å¿…é¡»å‘å¸ƒåˆ° OperatorHub ä¾›å…¨çƒç”¨æˆ·ä¸€é”®å®‰è£…ï¼Œä½ å¯ä»¥è€ƒè™‘ä½¿ç”¨ Operator SDKã€‚

> **æ³¨æ„**ï¼šå‘å¸ƒåˆ° OperatorHub å¹¶ä¸å¼ºåˆ¶ç»‘å®š Operator SDKã€‚SDK åªæ˜¯æä¾›äº†ä¸€å¥—ä¾¿æ·å·¥å…·å¸®ä½ ç”Ÿæˆ Bundle æ–‡ä»¶ã€‚ä½ å®Œå…¨å¯ä»¥ç”¨ Kubebuilder å¼€å‘ï¼Œç„¶åæ‰‹åŠ¨ç¼–å†™ Bundle æ–‡ä»¶ã€‚

### âš–ï¸ æˆ‘ä»¬å¦‚ä½•é€‰æ‹©ï¼Ÿ

é€šè¿‡ä¸Šæ–‡çš„å…¨å±€æ¢³ç†ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæåˆ°çš„å·¥å…·æ€»ç»“ä¸ºä¸¤å¤§ç±»ï¼š

**1. æ„å»ºæ—¶ï¼ˆBuild Timeï¼‰ï¼šè´Ÿè´£ç”Ÿæˆä»£ç å’Œé…ç½®**

  * `Kubebuilder/Operator SDK CLI`ï¼šè„šæ‰‹æ¶å·¥å…·ã€‚ç”Ÿæˆçš„ç›®å½•ç»“æ„ç¨³å®šä½†å›ºåŒ–ï¼Œåœ¨**å¤§ä»“æ¨¡å¼ï¼ˆMonorepoï¼‰** ä¸‹å¾€å¾€ä¼šè¢«æŠ›å¼ƒã€‚
  * `controller-gen`ï¼šè‹¦åŠ›ã€‚**å¿…é¡»ä¿ç•™**ï¼Œç”¨äºç”Ÿæˆ CRDã€RBAC å’Œ DeepCopy ä»£ç ã€‚

**2. è¿è¡Œæ—¶ï¼ˆRun Timeï¼‰ï¼šè´Ÿè´£ä¸šåŠ¡é€»è¾‘**

  * `client-go`ï¼šåŸºçŸ³ã€‚ç¦»äº†å®ƒï¼Œå°±æ— æ³•ä¸ K8s é€šä¿¡ã€‚
  * `controller-runtime`ï¼šå¤§ç®¡å®¶ã€‚å®ƒå¸®ä½ å±è”½äº† client-go çš„åº•å±‚ç»†èŠ‚ï¼Œæ˜¯ç°ä»£ Operator å¼€å‘çš„**æ ¸å¿ƒæ ‡å‡†åº“**ã€‚

**å›åˆ°æˆ‘ä»¬çš„å®æˆ˜åœºæ™¯ï¼š**

æˆ‘ä»¬çš„è½¦è”ç½‘ OTA å¹³å°é¡¹ç›®åŒ…å«å¤šä¸ªç»„ä»¶ï¼Œä¸”æœªæ¥éœ€æ‰©å±•å¤šä¸ªä¸šåŠ¡ç³»ç»Ÿï¼Œæ˜¯å…¸å‹çš„**å¤§ä»“æ¨¡å¼**ã€‚å› æ­¤ï¼Œåœ¨çœŸå®å·¥ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸ä¼šé€‰ç”¨ Kubebuilder CLI è¿™æ ·çš„è„šæ‰‹æ¶å·¥å…·ï¼Œè€Œæ˜¯ä¼šç›´æ¥å¼•å…¥ `controller-runtime` åº“æ¥æ„å»ºæˆ‘ä»¬çš„ Operatorã€‚

**ä½†æ˜¯**ï¼Œä½œä¸ºä¸€ç¯‡å…¥é—¨å®æˆ˜æ•™ç¨‹ï¼Œä¸ºäº†é™ä½å­¦ä¹ é—¨æ§›ï¼Œæ¥ä¸‹æ¥çš„æ¼”ç¤ºæˆ‘ä»¬å°†ä½¿ç”¨ **Kubebuilder** å¼€å‘ä¸€ä¸ª `Memcached` æ§åˆ¶å™¨ã€‚è¿™å°†ä½œä¸ºä¸€ä¸ªæ ‡å‡†åŒ–çš„å®æˆ˜æ¡ˆä¾‹ï¼Œå¸®åŠ©ä½ å¿«é€Ÿç†è§£ Operator çš„å¼€å‘æ–¹æ³•è®ºã€‚


## å®æˆ˜æ¡ˆä¾‹

> æœ¬æ¡ˆä¾‹åŸºäº [Kubebuilder å®˜æ–¹æ–‡æ¡£](https://book.kubebuilder.io/getting-started) ç¼–å†™ï¼Œé’ˆå¯¹æ ¸å¿ƒé€»è¾‘è¿›è¡Œäº†æ·±åº¦æ³¨è§£ã€‚
> 
> å®Œæ•´æºä»£ç å·²æ•´ç†å¥½ï¼Œè¯·å…³æ³¨æœ¬å…¬ä¼—å·ï¼šã€Œ*è®¤çŸ¥é‚£äº›äº‹*ã€å¹¶å›å¤ **8006** è·å–ã€‚

### ç¯å¢ƒå‡†å¤‡ï¼šå®‰è£… Kubebuilder

```bash
# ä¸‹è½½å¯¹åº”ç³»ç»Ÿæ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶
curl -L -o kubebuilder "https://go.kubebuilder.io/dl/latest/$(go env GOOS)/$(go env GOARCH)"

# èµ‹äºˆå¯æ‰§è¡Œæƒé™å¹¶ç§»åŠ¨åˆ° PATH è·¯å¾„
chmod +x kubebuilder && sudo mv kubebuilder /usr/local/bin/

# éªŒè¯å®‰è£…
kubebuilder version
```

### åˆå§‹åŒ–é¡¹ç›®

æ‰¾ä¸€ä¸ªåˆé€‚çš„ç›®å½•ï¼ˆå¦‚ `~/workspace`ï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªåä¸º `operator` çš„æ–‡ä»¶å¤¹å¹¶è¿›å…¥ã€‚

```bash
mkdir operator && cd operator
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åˆå§‹åŒ– Go æ¨¡å—å¹¶æ„å»º Kubebuilder é¡¹ç›®è„šæ‰‹æ¶ï¼š

```bash
# 1. åˆå§‹åŒ– Go Module (å®šä¹‰ä½ çš„é¡¹ç›®åŒ…å)
go mod init example.com/operator

# 2. åˆå§‹åŒ– Kubebuilder é¡¹ç›®
kubebuilder init --domain example.com
```

æ‰§è¡Œå®Œæ¯•åï¼Œä½ ä¼šå‘ç°å½“å‰ç›®å½•ä¸‹ç”Ÿæˆäº† `cmd/`ã€`config/`ã€`test/` ç­‰ä¸€ç³»åˆ—æ ‡å‡†çš„ç›®å½•ç»“æ„ã€‚

è®©æˆ‘ä»¬å…ˆçœ‹ä¸€çœ¼ç”Ÿæˆçš„å…¥å£æ–‡ä»¶ `cmd/main.go`ã€‚ä½ ä¼šå‘ç°å¦‚ä¸‹æ ¸å¿ƒä»£ç ï¼š

```go
import (
    // ...
    "k8s.io/apimachinery/pkg/runtime"
    clientgoscheme "k8s.io/client-go/kubernetes/scheme"
    ctrl "sigs.k8s.io/controller-runtime"
    // ...
)

var (
    scheme = runtime.NewScheme()
    // ...
)

func init() {
    // æ ¸å¿ƒå…³æ³¨ç‚¹ï¼šæ³¨å†Œ Scheme
    utilruntime.Must(clientgoscheme.AddToScheme(scheme))
    
    // ...
}
```

è¿™æ®µç®€çŸ­çš„ä»£ç ï¼Œå®Œç¾å°è¯äº†æˆ‘ä»¬å‰æ–‡çš„ç»“è®ºï¼š*Kubebuilder æœ¬è´¨ä¸Šæ˜¯åŸºäº `client-go` å’Œ `controller-runtime` çš„å°è£…ã€‚*

è¿™é‡Œæœ‰ä¸€ä¸ªéå¸¸å…³é”®çš„æ¦‚å¿µâ€”â€”**Scheme**ã€‚ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸º Kubernetes ä¸–ç•Œçš„ â€œå­—å…¸â€ æˆ– â€œç±»å‹æ³¨å†Œè¡¨â€ã€‚å®ƒè´Ÿè´£å»ºç«‹ Go è¯­è¨€ä¸­çš„ `Struct`ï¼ˆç»“æ„ä½“ï¼‰ä¸ K8s èµ„æºï¼ˆYAML/JSONï¼‰ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚åªæœ‰æ³¨å†Œåœ¨ Scheme é‡Œçš„ç±»å‹ï¼ŒOperator æ‰èƒ½è®¤è¯†ï¼Œæ‰èƒ½æ­£ç¡®åœ°è¿›è¡Œåºåˆ—åŒ–ï¼ˆStruct è½¬ YAMLï¼‰å’Œååºåˆ—åŒ–ï¼ˆYAML è½¬ Structï¼‰ã€‚

**ä¸ºä»€ä¹ˆè¦æ‰§è¡Œ clientgoscheme.AddToSchemeï¼Ÿ**

`clientgoscheme` è¿™ä¸ªåº“ä¸­åŒ…å«äº† Kubernetes æ‰€æœ‰çš„ API **åŸç”Ÿèµ„æº**ï¼ˆå¦‚ Pod, Deployment, Service ç­‰ï¼‰ã€‚å› ä¸ºæˆ‘ä»¬çš„ Operator é€šå¸¸ä¸ä»…éœ€è¦æ“ä½œè‡ªå®šä¹‰èµ„æºï¼ˆCRï¼‰ï¼Œè¿˜éœ€è¦æ“ä½œ K8s çš„åŸç”Ÿèµ„æºã€‚è¿™è¡Œä»£ç çš„ä½œç”¨ï¼Œå°±æ˜¯æŠŠ K8s åŸç”Ÿèµ„æºçš„å®šä¹‰åŠ è½½åˆ°æˆ‘ä»¬çš„â€œå­—å…¸â€é‡Œï¼Œè®© Operator èƒ½â€œè¯»æ‡‚â€å®ƒä»¬ã€‚

åç»­ï¼Œå½“æˆ‘ä»¬å®šä¹‰äº†è‡ªå®šä¹‰èµ„æº `Memcached` åï¼Œä¹Ÿéœ€è¦é€šè¿‡ç±»ä¼¼çš„ `AddToScheme` æ–¹æ³•å°†å…¶æ³¨å†Œè¿›å»ï¼Œè¿™æ · Operator æ‰èƒ½çœŸæ­£æ¥ç®¡æˆ‘ä»¬çš„ä¸šåŠ¡ã€‚

### åˆ›å»º Memcached APIï¼ˆCRDï¼‰

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¼€å§‹åˆ›å»ºæ ¸å¿ƒèµ„æºã€‚åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç³»ç»Ÿä¼šè¯¢é—®æ˜¯å¦åˆ›å»º Resourceï¼ˆèµ„æºå®šä¹‰ï¼‰å’Œ Controllerï¼ˆæ§åˆ¶å™¨é€»è¾‘ï¼‰ï¼Œè¯·å…¨éƒ¨è¾“å…¥ `y`ã€‚

```bash
kubebuilder create api --group cache --version v1alpha1 --kind Memcached
```

æ‰§è¡Œå®Œæ¯•åï¼Œä½ ä¼šå‘ç°é¡¹ç›®ç›®å½•ä¸­å¤šäº†ä¸¤ä¸ªå…³é”®æ–‡ä»¶å¤¹ï¼š

* `api/v1alpha1`ï¼šæˆ‘ä»¬å°†åœ¨è¿™é‡Œå®šä¹‰ Custom Resource (CR) çš„æ•°æ®ç»“æ„ã€‚

* `internal/controller`ï¼šæˆ‘ä»¬å°†åœ¨è¿™é‡Œç¼–å†™è°ƒè°å¾ªç¯ï¼ˆReconcile Loopï¼‰çš„ä¸šåŠ¡é€»è¾‘ã€‚

Kubebuilder ä¼šæ ¹æ®ä»£ç é‡Œ â€œ**é”šç‚¹æ³¨é‡Š**â€ï¼ˆ`// +kubebuilder:scaffold:...`ï¼‰æ¥è‡ªåŠ¨æ’å…¥å¯¹åº”çš„ä»£ç ã€‚ç°åœ¨ï¼Œä½ å†æ¬¡æ‰“å¼€ `cmd/main.go`ï¼Œä½ ä¼šçœ‹åˆ°åˆšåˆšåˆ›å»ºçš„ API å·²ç»è‡ªåŠ¨æ³¨å†Œåˆ° Scheme äº†ã€‚

```go
import (
    // ...
    cachev1alpha1 "example.com/operator/api/v1alpha1"
	  // +kubebuilder:scaffold:imports
)

// ...

func init() {
    // ...

    utilruntime.Must(cachev1alpha1.AddToScheme(scheme))
	  // +kubebuilder:scaffold:scheme
}
```

### å®šä¹‰ APIï¼šæè¿° Memcached é•¿ä»€ä¹ˆæ ·

è¦ç®¡ç† Memcachedï¼Œæˆ‘ä»¬é¦–å…ˆå¾—å®šä¹‰å®ƒçš„â€œæœŸæœ›çŠ¶æ€â€ï¼ˆSpecï¼‰å’Œâ€œå®é™…çŠ¶æ€â€ï¼ˆStatusï¼‰ã€‚

æ‰“å¼€ `api/v1alpha1/memcached_types.go` æ–‡ä»¶ã€‚ä½ ä¼šå‘ç° Kubebuilder å·²ç»å¸®æˆ‘ä»¬å®šä¹‰å¥½äº† Memcachedã€MemcachedSpec å’Œ MemcachedStatus è¿™å‡ ä¸ªç»“æ„ä½“ã€‚

æˆ‘ä»¬éœ€è¦æ¸…ç©ºé»˜è®¤ç”Ÿæˆçš„ç¤ºä¾‹å­—æ®µï¼Œå°†å…¶ä¿®æ”¹ä¸ºå¦‚ä¸‹ä»£ç ï¼š

```go
// MemcachedSpec å®šä¹‰äº† Memcached çš„æœŸæœ›çŠ¶æ€
type MemcachedSpec struct {
    // Size å®šä¹‰äº† Memcached é›†ç¾¤çš„æœŸæœ›å‰¯æœ¬æ•°é‡
    // +kubebuilder:validation:Minimum=1
    // +kubebuilder:validation:Maximum=5
    Size int32 `json:"size,omitempty"`
}

// MemcachedStatus å®šä¹‰äº† Memcached çš„è§‚å¯ŸçŠ¶æ€ï¼ˆå®é™…è¿è¡ŒçŠ¶æ€ï¼‰
type MemcachedStatus struct {
    // Nodes è®°å½•äº†å½“å‰è¿è¡Œçš„ Pod åç§°åˆ—è¡¨
    // +optional
    Nodes []string `json:"nodes,omitempty"`
}
```

è¿™é‡Œæœ‰ä¸¤ä¸ªæŠ€æœ¯ç»†èŠ‚å€¼å¾—æ³¨æ„ï¼š

1. **Markers**ï¼ˆ`//+kubebuilder...`ï¼‰ï¼šè¿˜è®°å¾—æˆ‘ä»¬åœ¨å·¥å…·é€‰å‹ä¸­æåˆ°çš„ `controller-gen` å—ï¼Ÿè¿™äº›æ³¨é‡Šå°±æ˜¯å†™ç»™å®ƒçœ‹çš„ã€‚å®ƒä¼šè¯»å–è¿™äº›æ³¨é‡Šï¼Œå¹¶å°†éªŒè¯é€»è¾‘ç”Ÿæˆåˆ° CRD çš„ YAML æ–‡ä»¶ä¸­ã€‚è¿™å¸¦æ¥çš„æ•ˆæœå°±æ˜¯ï¼šå¦‚æœç”¨æˆ·æäº¤çš„ YAML ä¸­ `size` ä¸åœ¨ [1, 5] åŒºé—´å†…ï¼Œ**API Server ä¼šç›´æ¥æ‹’ç»è¯·æ±‚**ã€‚è¿™ç§â€œå‰ç½®æ ¡éªŒâ€æ¯”åœ¨ä»£ç é‡Œåˆ¤æ–­è¦é«˜æ•ˆå¾—å¤šã€‚

2. **Optional**ï¼ˆ`// +optional`ï¼‰ï¼šé€šå¸¸ï¼Œåœ¨å®é™…çŠ¶æ€ï¼ˆStatusï¼‰é‡Œï¼Œæ‰€æœ‰å­—æ®µéƒ½æ¨èåŠ ä¸Šè¿™ä¸ªæ ‡è®°ã€‚å› ä¸ºå½“ç”¨æˆ·åˆšåˆšåˆ›å»º CR æ—¶ï¼ˆæ¯”å¦‚ `kubectl apply`ï¼‰ï¼Œç³»ç»Ÿè¿˜æ²¡å¼€å§‹åˆ›å»º Podï¼Œæ‰€ä»¥ Status å¿…ç„¶æ˜¯ç©ºçš„ã€‚å¦‚æœä¸æ ‡è®°ä¸ºå¯é€‰ï¼ŒKubernetes å¯èƒ½ä¼šå› ä¸ºæ ¡éªŒå¤±è´¥è€Œé˜»æ­¢èµ„æºçš„åˆ›å»ºã€‚

ä¿®æ”¹å®Œç»“æ„ä½“åï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥åŒæ­¥ç”Ÿæˆä»£ç å’Œé…ç½®æ–‡ä»¶ï¼š

```bash
make manifests generate
```

è¿™æ˜¯ä¸¤ä¸ªå‘½ä»¤çš„ç»„åˆï¼Œå®ƒä»¬é€šè¿‡ `controller-gen` å®Œæˆäº†ä¸¤ä»¶å¤§äº‹ï¼š

1. `make manifests`ï¼šæ‰«æç»“æ„ä½“æ³¨é‡Šï¼Œé‡æ–°ç”Ÿæˆ `config/crd/bases` ä¸‹çš„ CRD YAML æ–‡ä»¶ï¼ˆä½ çš„æ ¡éªŒè§„åˆ™å°±åœ¨è¿™é‡Œç”Ÿæ•ˆï¼‰ã€‚

2. `make generate`ï¼šæ‰«æä»£ç ï¼Œæ›´æ–° `api/v1alpha1/zz_generated.deepcopy.go` æ–‡ä»¶ï¼ˆå› ä¸º K8s ä¸­çš„å¯¹è±¡å¿…é¡»æ”¯æŒæ·±æ‹·è´ï¼Œè¿™éƒ¨åˆ†ç¹ççš„ä»£ç ç”±å·¥å…·è‡ªåŠ¨å®Œæˆï¼‰ã€‚

> **æ³¨æ„**ï¼šæ¯å½“ä½ ä¿®æ”¹äº† `api/` ç›®å½•ä¸‹çš„ Go ç»“æ„ä½“ï¼Œéƒ½å¿…é¡»é‡æ–°æ‰§è¡Œè¿™æ¡å‘½ä»¤ï¼Œå¦åˆ™ä½ çš„ä»£ç ä¸ CRD å®šä¹‰å°†ä¼šä¸ä¸€è‡´ã€‚

### ç¼–å†™è°ƒè°å¾ªç¯ï¼ˆReconcileï¼‰

æ•°æ®ç»“æ„å®šä¹‰å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬è¿›å…¥ Operator å¼€å‘çš„æ ¸å¿ƒâ€”â€”**ç¼–å†™æ§åˆ¶å™¨ï¼ˆControllerï¼‰**ã€‚

æ‰“å¼€ `internal/controller/memcached_controller.go`ã€‚æˆ‘ä»¬è¦åœ¨è¿™é‡Œå®ç° `Reconcile` å‡½æ•°ã€‚

è¿™ä¸ªå‡½æ•°çš„é€»è¾‘éå¸¸æ ‡å‡†åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶ç®€åŒ–ä¸ºä¸‰æ­¥æ›²ï¼š**Observeï¼ˆè§‚æµ‹ï¼‰ã€Diffï¼ˆå¯¹æ¯”åˆ†æï¼‰ã€Actï¼ˆæ‰§è¡Œå˜æ›´ï¼‰**ã€‚

ä¸ºäº†èšç„¦æ ¸å¿ƒæµç¨‹ï¼Œä¸‹æ–‡ä»…å±•ç¤ºå…³é”®ä»£ç ç‰‡æ®µï¼Œå®Œæ•´é€»è¾‘è¯·å‚è€ƒæºç ã€‚

**ç¬¬ä¸€æ­¥ï¼šObserveï¼ˆè§‚æµ‹å½“å‰çŠ¶æ€ï¼‰**

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®è¯·æ±‚ä¸­çš„ `NamespacedName`ï¼Œå» K8s è·å–æœ€æ–°çš„ `Memcached` å¯¹è±¡ï¼ˆæˆ‘ä»¬çš„ CRï¼‰ä»¥åŠå®ƒå…³è”çš„ `Deployment`ã€‚

```go
// 1. è·å– Memcached å®ä¾‹
memcached := &cachev1alpha1.Memcached{}
if err := r.Get(ctx, req.NamespacedName, memcached); err != nil {
    // å¦‚æœæ‰¾ä¸åˆ°ï¼ˆå¯èƒ½è¢«åˆ é™¤äº†ï¼‰ï¼Œåˆ™ç›´æ¥å¿½ç•¥ï¼Œä¸å†æ’é˜Ÿ
    return ctrl.Result{}, client.IgnoreNotFound(err)
}

// 2. è·å–å…³è”çš„ Deployment
found := &appsv1.Deployment{}
err := r.Get(ctx, types.NamespacedName{Name: memcached.Name, Namespace: memcached.Namespace}, found)
// (æ­¤å¤„çœç•¥äº† Deployment ä¸å­˜åœ¨æ—¶åˆ›å»ºå®ƒçš„ä»£ç ï¼Œè¯¦è§æºç )
```

**ç¬¬äºŒæ­¥ï¼šDiffï¼ˆå¯¹æ¯”æœŸæœ›çŠ¶æ€ï¼‰**

æ‹¿åˆ°å®é™…èµ„æºåï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ¯”â€œç”¨æˆ·æœŸæœ›çš„â€ï¼ˆSpecï¼‰å’Œâ€œé›†ç¾¤é‡Œå®é™…è·‘çš„â€ï¼ˆFoundï¼‰æ˜¯å¦ä¸€è‡´ã€‚

æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæ ¸å¿ƒå…³æ³¨ç‚¹æ˜¯ **å‰¯æœ¬æ•°ï¼ˆReplicasï¼‰**ã€‚

```go
size := memcached.Spec.Size

// å¦‚æœå®é™…è¿è¡Œçš„å‰¯æœ¬æ•° != æœŸæœ›çš„å‰¯æœ¬æ•°
if *found.Spec.Replicas != size {
    found.Spec.Replicas = &size
    
    // æ ‡è®°éœ€è¦æ›´æ–°
    log.Info("Detected a drift", "expect", size, "actual", *found.Spec.Replicas)
    
    // è¿›å…¥ Act é˜¶æ®µ...
}
```

**ç¬¬ä¸‰æ­¥ï¼šActï¼ˆæ‰§è¡Œå˜æ›´ä¸çŠ¶æ€å›å†™ï¼‰**

ä¸€æ—¦å‘ç°çŠ¶æ€ä¸ä¸€è‡´ï¼ˆDriftï¼‰ï¼Œç«‹å³æ‰§è¡Œå˜æ›´ã€‚æ­¤å¤–ï¼Œæ— è®º Deployment æ˜¯å¦å˜æ›´ï¼Œæˆ‘ä»¬é€šå¸¸éƒ½éœ€è¦åŒæ­¥æœ€æ–°çš„ Pod åˆ—è¡¨åˆ° Memcached çš„ Status ä¸­ï¼Œä»¥ä¾¿ç”¨æˆ·æŸ¥çœ‹ã€‚

```go
// 3.1 æ‰§è¡Œ Deployment å˜æ›´
if err := r.Update(ctx, found); err != nil {
    return ctrl.Result{}, err
}

// 3.2 å›å†™ Status
podNames := getPodNames(podList.Items)
if !reflect.DeepEqual(podNames, memcached.Status.Nodes) {
    memcached.Status.Nodes = podNames
    if err := r.Status().Update(ctx, memcached); err != nil {
        return ctrl.Result{}, err
    }
}
```


## æœ€ä½³å®è·µ

Reconcile å‡½æ•°çš„è¿”å›å€¼ `(ctrl.Result, error)` å†³å®šäº†æ§åˆ¶å™¨çš„ä¸‹ä¸€æ­¥è¡ŒåŠ¨ã€‚åœ¨ç°ä»£ Operator å¼€å‘ä¸­ï¼Œæ¨èä»¥ä¸‹ä¸‰ç§æ ‡å‡†æ¨¡å¼ï¼š

### 1. å¤„ç†æˆåŠŸ (Success)

```go
return ctrl.Result{}, nil
```

è¿™æ˜¯æœ€å¸¸ç”¨çš„è¿”å›æ–¹å¼ã€‚è¡¨ç¤ºæœ¬æ¬¡è°ƒè°å·²æˆåŠŸå®Œæˆï¼Œæ— éœ€ç«‹å³é‡è¯•ã€‚

ä½ å¯èƒ½ä¼šæ‹…å¿ƒâ€œå¦‚æœæˆ‘ä¸é‡è¯•ï¼Œæ€ä¹ˆä¿è¯çŠ¶æ€ä¸€ç›´å¯¹å‘¢ï¼Ÿâ€ã€‚åˆ«æ‹…å¿ƒï¼ŒKubernetes æ˜¯**äº‹ä»¶é©±åŠ¨**çš„ã€‚åªè¦ä½ åœ¨ Reconcile ä¸­æ‰§è¡Œäº† `Update()` æ“ä½œï¼ˆæ”¹å˜äº†èµ„æºçŠ¶æ€ï¼‰ï¼ŒAPI Server å°±ä¼šå‘å‡ºå˜æ›´äº‹ä»¶ï¼Œä½ çš„ Controller ç›‘å¬åˆ°äº‹ä»¶åï¼Œä¼š**è‡ªåŠ¨**è§¦å‘ä¸‹ä¸€æ¬¡ Reconcileã€‚å› æ­¤ï¼Œ**æ‰‹åŠ¨è¦æ±‚é‡è¯•é€šå¸¸æ˜¯å¤šä½™çš„**ã€‚

### 2. å¤„ç†å¤±è´¥ (Error)

```go
return ctrl.Result{}, err
```

å½“ä»£ç æ‰§è¡Œå‡ºé”™ï¼ˆå¦‚ API è°ƒç”¨å¤±è´¥ï¼‰æ—¶ï¼Œç›´æ¥è¿”å› errorã€‚

æ§åˆ¶å™¨ä¼šå°†è¯¥è¯·æ±‚é‡æ–°æ”¾å…¥å·¥ä½œé˜Ÿåˆ—ã€‚æ­¤æ—¶ä¼šè‡ªåŠ¨å¯ç”¨**é™é€Ÿå™¨ï¼ˆRateLimiterï¼‰**ï¼Œè¿›è¡Œ**æŒ‡æ•°é€€é¿**é‡è¯•ï¼ˆä¾‹å¦‚ï¼š5ms -> 10ms -> 20ms...ï¼‰ã€‚è¿™èƒ½é¿å…å› æ­»å¾ªç¯å¯¼è‡´çš„ CPU é£™å‡æˆ–é›ªå´©æ•ˆåº”ã€‚

### 3. å®šæ—¶è½®è¯¢ (Polling)

```go
return ctrl.Result{RequeueAfter: 2 * time.Minute}, nil
```

ä½ å¯ä»¥ä½¿ç”¨ `RequeueAfter` æ˜¾å¼è¦æ±‚åœ¨æŒ‡å®šæ—¶é—´ï¼ˆå¦‚ 2 åˆ†é’Ÿï¼‰åï¼Œæ— è®ºæœ‰æ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œå¼ºåˆ¶è§¦å‘ä¸€æ¬¡ Reconcileã€‚

è¿™é€šå¸¸ä½œä¸ºâ€œ**æœ€åä¸€é“ä¿é™©**â€ã€‚é˜²æ­¢å› æå°æ¦‚ç‡çš„äº‹ä»¶ä¸¢å¤±å¯¼è‡´çŠ¶æ€ä¸åŒæ­¥ï¼Œæˆ–è€…ç”¨äºæ£€æŸ¥æŸäº›ä¸è§¦å‘ K8s äº‹ä»¶çš„å¤–éƒ¨ç³»ç»ŸçŠ¶æ€ã€‚

### âš ï¸ è­¦ç¤ºï¼šå·²å¼ƒç”¨çš„ `Requeue: true`

åœ¨æ—©æœŸçš„æ•™ç¨‹ä¸­ï¼Œç”šè‡³å®˜ç½‘ç¤ºä¾‹ä¸­ï¼Œä½ å¯èƒ½ä¼šçœ‹åˆ° `return ctrl.Result{Requeue: true}, nil` è¿™ç§å†™æ³•ã€‚**è¯·æ³¨æ„ï¼Œè¿™åœ¨æºç ä¸­å·²è¢«æ ‡è®°ä¸ºå¼ƒç”¨ã€‚**

å¦‚æœä½ ç‚¹å‡»æŸ¥çœ‹ `Result` ç»“æ„ä½“çš„æºç ï¼Œä¼šçœ‹åˆ°å¦‚ä¸‹æ³¨é‡Šï¼ˆå·²ç¿»è¯‘ï¼‰ï¼š

```go
type Result struct {
    // Requeue æŒ‡ç¤ºæ§åˆ¶å™¨ä½¿ç”¨å·¥ä½œé˜Ÿåˆ—ï¼ˆWorkQueueï¼‰çš„é™é€Ÿå™¨ï¼ˆRateLimiterï¼‰
    // æ‰§è¡Œä¸€æ¬¡å—é™é€Ÿæ§åˆ¶çš„é‡æ–°å…¥é˜Ÿæ“ä½œã€‚é»˜è®¤ä¸º falseã€‚
    //
    // æ­¤è®¾ç½®å·²è¢«ã€å¼ƒç”¨ã€‘ï¼Œå› ä¸ºå®ƒä¼šå¼•èµ·æ··æ·†ï¼Œä¸”æ²¡æœ‰å……åˆ†çš„ç†ç”±å»ä½¿ç”¨å®ƒã€‚
    //
    // å½“ä½ éœ€è¦ç­‰å¾…æŸä¸ªå¤–éƒ¨äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œåº”å½“æ˜ç¡®ä½¿ç”¨ï¼š
    // 1. â€œè·ç¦»è¯¥äº‹ä»¶é¢„è®¡å‘ç”Ÿçš„æ—¶é—´é•¿åº¦â€ï¼ˆduration until it is supposed to happenï¼‰
    // 2. æˆ–è€…â€œä¸€ä¸ªåˆé€‚çš„è½®è¯¢é—´éš”â€ï¼ˆappropriate poll intervalï¼‰
    //
    // è€Œä¸åº”è¯¥ä¾èµ–ç”±é™é€Ÿå™¨ï¼ˆRateLimiterï¼‰äº§ç”Ÿçš„é—´éš”ã€‚
    // é™é€Ÿå™¨çš„è®¾è®¡åˆè¡·ä»…ä»…æ˜¯ä¸ºäº†æ§åˆ¶â€œé”™è¯¯é‡è¯•â€ï¼ˆretry on errorï¼‰ã€‚
    //
    // å·²å¼ƒç”¨ï¼šè¯·æ”¹ç”¨ `RequeueAfter`ã€‚
    Requeue bool

    // ...
}
```

### æ€»ç»“

ç¤¾åŒºå¼ºçƒˆå»ºè®®åŒºåˆ† **â€œæ•…éšœâ€** ä¸ **â€œç­‰å¾…â€** çš„ç•Œé™ã€‚

* å¦‚æœæ˜¯æ•…éšœï¼Œè¿”å› `err`ã€‚
* å¦‚æœæ˜¯ç­‰å¾…ï¼ˆå¦‚ç­‰å¾… Pod å¯åŠ¨ï¼‰ï¼Œè¿”å› `RequeueAfter`ã€‚
* å¦‚æœåªæ˜¯æƒ³ç«‹å³é‡è¯•ï¼Œé€šå¸¸æ„å‘³ç€ä½ çš„é€»è¾‘æœ‰é—®é¢˜ï¼Œä½ åº”è¯¥ä¾èµ–äº‹ä»¶é©±åŠ¨ã€‚


## RBAC

åœ¨ Reconcile å‡½æ•°çš„ä¸Šæ–¹ï¼Œä½ ä¼šçœ‹åˆ°ä¸€å † `//+kubebuilder:rbac...` æ³¨é‡Šï¼š

```go
// +kubebuilder:rbac:groups=cache.example.com,resources=memcacheds,verbs=get;list;watch;create;update;patch;
```

è¿™äº› **RBAC æ³¨é‡Š**éå¸¸é‡è¦ã€‚Operator æœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ªæ™®é€šçš„ Podï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒæ²¡æœ‰ä»»ä½•æƒé™ã€‚è¿™äº›æ³¨é‡Šæ˜¯å†™ç»™ `controller-gen` å·¥å…·çœ‹çš„ã€‚å·¥å…·ä¼šè¯»å–è¿™äº›æ³¨é‡Šï¼Œç”Ÿæˆå¯¹åº”çš„ `Role` å’Œ `RoleBinding`ï¼Œèµ‹äºˆ Operator æ“ä½œ Memcached å’Œ Deployment çš„æƒé™ã€‚**å¦‚æœä½ å‘ç° Operator æŠ¥ `403 Forbidden` é”™è¯¯ï¼Œè¯·é¦–å…ˆæ£€æŸ¥è¿™é‡Œã€‚**


## ğŸš€ éƒ¨ç½²ä¸éªŒè¯

ä»£ç å†™å®Œäº†ï¼Œæ¿€åŠ¨äººå¿ƒçš„æ—¶åˆ»åˆ°äº†ï¼æˆ‘ä»¬è¦æŠŠå®ƒè·‘èµ·æ¥ï¼Œäº²çœ¼è§è¯å®ƒå¦‚ä½•è‡ªåŠ¨åŒ–ç®¡ç† Memcached é›†ç¾¤ã€‚

> **å‰ç½®æ¡ä»¶**ï¼š
> 
> è¯·ç¡®ä¿ä½ çš„æœ¬åœ°ç»ˆç«¯èƒ½å¤Ÿæ­£ç¡®è¿æ¥åˆ°ä¸€ä¸ª Kubernetes é›†ç¾¤ï¼ˆæ‹¥æœ‰ `cluster-admin` æƒé™ï¼‰ã€‚
> é€šå¸¸æ„å‘³ç€ä½ çš„ `~/.kube/config` æ–‡ä»¶é…ç½®æ­£ç¡®ã€‚
>
> **å¦‚æœä½ è¿˜æ²¡æœ‰é›†ç¾¤ï¼Œæ¬¢è¿å­¦ä¹ æˆ‘çš„[äºŒè¿›åˆ¶éƒ¨ç½²è¯¾ç¨‹](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI0NjA5NTY1Nw==&action=getalbum&album_id=4181994987560550414#wechat_redirect)ï¼Œåœ¨æœ¬åœ°å¿«é€Ÿå¯åŠ¨ä¸€ä¸ªæµ‹è¯•é›†ç¾¤ã€‚**

### 1. å®‰è£… CRD

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æŠŠ `Memcached` è¿™ä¸ªè‡ªå®šä¹‰èµ„æºçš„å®šä¹‰ï¼ˆCRDï¼‰æ³¨å†Œåˆ°é›†ç¾¤ä¸­ã€‚è¿™æ · K8s æ‰èƒ½è®¤è¯†ä»€ä¹ˆæ˜¯ "Memcached"ã€‚

```bash
make install
```

é¢„æœŸè¾“å‡ºï¼š

```text
...
customresourcedefinition.apiextensions.k8s.io/memcacheds.cache.example.com created
```

### 2. å¯åŠ¨æ§åˆ¶å™¨

åœ¨å¼€å‘é˜¶æ®µï¼Œä¸ºäº†æ–¹ä¾¿è°ƒè¯•ï¼Œæˆ‘ä»¬é€šå¸¸ä¸æ‰“åŒ… Docker é•œåƒï¼Œè€Œæ˜¯ç›´æ¥åœ¨æœ¬åœ°è¿è¡Œæ§åˆ¶å™¨ä»£ç ã€‚å®ƒä¼šè‡ªåŠ¨ä½¿ç”¨ä½ æœ¬åœ°çš„ `~/.kube/config` è¿æ¥è¿œç¨‹é›†ç¾¤ã€‚

```bash
make run
```

é¢„æœŸè¾“å‡ºï¼š

```text
...
INFO	starting server	{"name": "health probe", "addr": "[::]:8081"}
INFO	Starting Controller	{"controller": "memcached", "controllerGroup": "cache.example.com", "controllerKind": "Memcached"}
INFO	Starting workers	{"controller": "memcached", "controllerGroup": "cache.example.com", "controllerKind": "Memcached", "worker count": 1}
...
```

**ä¿æŒè¿™ä¸ªç»ˆç«¯çª—å£ä¸è¦å…³é—­**ï¼Œæ§åˆ¶å™¨ç°åœ¨æ­£åœ¨å®æ—¶ç›‘æ§é›†ç¾¤çŠ¶æ€ã€‚

### 3. åˆ›å»ºæµ‹è¯•å®ä¾‹

æ–°æ‰“å¼€ä¸€ä¸ªç»ˆç«¯çª—å£ï¼Œæˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ª `Memcached` å®ä¾‹ã€‚æˆ‘ä»¬å°†æœŸæœ›çš„å‰¯æœ¬æ•° `size` è®¾ç½®ä¸º **3**ã€‚

```bash
# ä½¿ç”¨ heredoc è¯­æ³•ç›´æ¥é€šè¿‡ stdin åº”ç”¨ YAML
kubectl apply -f - <<EOF
apiVersion: cache.example.com/v1alpha1
kind: Memcached
metadata:
  name: memcached-sample
spec:
  size: 3
EOF
```

### 4. éªŒè¯æˆæœ

ç°åœ¨ï¼Œè§è¯å¥‡è¿¹çš„æ—¶åˆ»åˆ°äº†ã€‚

**éªŒè¯ 1ï¼šæ£€æŸ¥ Memcached CR å¯¹è±¡**   
æŸ¥çœ‹æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„èµ„æºï¼Œç‰¹åˆ«æ˜¯å®ƒçš„ `Status` å­—æ®µã€‚å¦‚æœæ§åˆ¶å™¨å·¥ä½œæ­£å¸¸ï¼Œå®ƒåº”è¯¥å·²ç»æŠŠå®é™…è¿è¡Œçš„ Pod åˆ—è¡¨å›å†™åˆ°äº†çŠ¶æ€é‡Œã€‚

```bash
kubectl get memcacheds memcached-sample -o yaml
```

é¢„æœŸè¾“å‡ºç‰‡æ®µï¼š

```yaml
apiVersion: cache.example.com/v1alpha1
kind: Memcached
metadata:
  name: memcached-sample
  ...
spec:
  size: 3
status:
  nodes:  # çœ‹åˆ°è¿™é‡Œè¢«å¡«å……ï¼Œè¯´æ˜æ§åˆ¶å™¨é€»è¾‘æ‰§è¡ŒæˆåŠŸï¼
  - memcached-sample-647788965d-6bpl4
  - memcached-sample-647788965d-kv766
  - memcached-sample-647788965d-wm979
```

**éªŒè¯ 2ï¼šæ£€æŸ¥åº•å±‚ Pod**   
çœ‹çœ‹åˆ°åº•æœ‰æ²¡æœ‰ 3 ä¸ª Pod åœ¨è¿è¡Œï¼š

```bash
kubectl get pods |grep memcached-sample
```

é¢„æœŸè¾“å‡ºï¼š

```text
NAME                                READY   STATUS    RESTARTS   AGE
memcached-sample-647788965d-6bpl4   1/1     Running   0          92s
memcached-sample-647788965d-kv766   1/1     Running   0          92s
memcached-sample-647788965d-wm979   1/1     Running   0          92s
```

### ğŸ® ç©ç‚¹æ›´é«˜çº§çš„

æ—¢ç„¶è·‘èµ·æ¥äº†ï¼Œä¸å¦¨è¯•è¯• **â€œè‡ªæ„ˆèƒ½åŠ›â€**ï¼š

1. æ‰‹åŠ¨åˆ æ‰ä¸€ä¸ª Podï¼š`kubectl delete pod memcached-sample-xxxx`ã€‚ä½ ä¼šå‘ç°æ§åˆ¶å™¨é©¬ä¸Šåˆæ‹‰èµ·ä¸€ä¸ªæ–°çš„ã€‚
2. ä¿®æ”¹ CR å‰¯æœ¬æ•°ï¼š`kubectl edit memcacheds memcached-sample`ï¼ŒæŠŠ `size` æ”¹æˆ 5ã€‚ä½ ä¼šå‘ç° Pod æ•°é‡è‡ªåŠ¨æ‰©å®¹åˆ°äº† 5 ä¸ªã€‚

è¿™å°±æ˜¯ Operator çš„é­…åŠ›ï¼


## ç»“è¯­

æœ¬æ–‡å¸¦ä½ æ¢³ç†äº† Operator å¼€å‘çš„å·¥å…·ç”Ÿæ€ï¼Œå¹¶é€šè¿‡ä¸€ä¸ª Memcached å®æˆ˜æ¡ˆä¾‹ï¼Œè·‘é€šäº†æ§åˆ¶å™¨çš„æ ¸å¿ƒéª¨æ¶ã€‚

ä½†çœŸæ­£çš„å·¥ç¨‹æŒ‘æˆ˜å¾€å¾€è—åœ¨ç»†èŠ‚é‡Œï¼ˆå¦‚ OwnerReference ç»‘å®šã€Pod åˆ—è¡¨è¿‡æ»¤ç­‰ï¼‰ã€‚ä¸ºæ­¤ï¼Œæˆ‘å‡†å¤‡äº†åŒ…å«è¯¦ç»†æ³¨é‡Šçš„å®Œæ•´æºä»£ç ä¾›ä½ å‚è€ƒã€‚è¯·å…³æ³¨æœ¬å…¬ä¼—å·ï¼šã€Œ*è®¤çŸ¥é‚£äº›äº‹*ã€å¹¶å›å¤ **8006** è·å–ã€‚
